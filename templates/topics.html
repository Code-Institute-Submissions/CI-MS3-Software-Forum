<!DOCTYPE html>
{% extends 'base.html'%}
{% block content %}
<section id="search-section">
    <h1>We help you achieve your goal. Choose the right software for your purpose.</h1>
    <div class="row">
        <div class="input-field search-field col s12 m6">
            <input placeholder="Search" type="search" class="validate" id="searchfield">
        </div>
        <div id="search-options" class="col s12 m6">
            <label>
            <input type="checkbox" class="filled-in" id="searchInTitles" value="titles" checked/>
            <span>Titles</span>
            </label>
            <label>
            <input type="checkbox" class="filled-in" id="searchInDetails" value="details" checked/>
            <span>Details</span>
            </label>
            <label>
            <input type="checkbox" class="filled-in" id="searchInComments" value="comments" checked/>
            <span>Comments</span>
            </label>
        </div>
    </div>
</section>
<section id="topics-section" class="container">
    <!-- table header -->
    <form>
        <div class="row">
            <div class="col s5">
                <h4>Title</h4>
            </div>
            <div class="col s2">
                <h4>Date published</h4>
                <div class="input-field">
                    <select id="sortdate">
                        <option value="1" selected>Ascending</option>
                        <option value="-1">Descending</option>
                    </select>
                </div>
            </div>
            <div class="col s2">
                <h4>Platform</h4>
                <div class="input-field">
                    <select multiple id="platformfilter">
                        <option value="Windows" selected>Windows</option>
                        <option value="MacOS" selected>MacOS</option>
                        <option value="Linux" selected>Linux</option>
                        <option value="Android" selected>Android</option>
                        <option value="iOS" selected>iOS</option>
                        <option value="Other" selected>Other</option>
                    </select>
                </div>
            </div>
            <div class="col s1">
                <h4>Cost</h4>
                <div class="input-field">
                    <select id="costfilter">
                        <option value="All" selected>All</option>
                        <option value="Free">Free</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
            </div>
            <div class="col s2">
                <h4>Answers</h4>
                <div class="input-field">
                    <select id="answersfilter">
                        <option value="All" selected>All</option>
                        <option value="Answered">Answered</option>
                        <option value="Unanswered">Unanswered</option>
                    </select>
                </div>
            </div>
        </div>
    </form>
    <!-- creating the table with the topics -->
    <div id="topics-table">
        <div class="row">
            <ul class="collapsible" data-collapsible="accordion">
                {% for topic in topics %}
                <li>
                    <div class="collapsible-header">
                        <div class="col s5">
                            <p>{{ topic.title }}</p>
                            <p class="right-align">{{ topic.author }}</p>
                        </div>
                        <div class="col s2">
                            {{ topic.publish_date.strftime('%d-%m-%Y') }}
                        </div>
                        <div class="col s2">
                            {% for getos in topic.os %}
                            {{ getos }}
                            {% if not loop.last %}
                            ,
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div class="col s1">
                            {{ topic.cost }}
                        </div>
                        <div class="col s1">
                            {{ topic.comments|length }}
                        </div>
                        <div class="col s1">
                            <i class="material-icons">expand_more</i>
                        </div>
                    </div>
                    <div class="collapsible-body">
                        <div class="row">
                            <div class="col s11">
                                {{ topic.details }}
                            </div>
                            <div class="col s1">
                                <a href="{{ url_for('delete_topic', topic_id=topic._id) }}"><i class="fas fa-trash-alt"></i></a>
                                <a href="{{ url_for('edit_topic', topic_id=topic._id) }}"><i class="fas fa-edit"></i></a>
                            </div>
                        </div>
                        <hr>
                        <!-- Display the answer(s) -->
                        {% for object in topic.comments %}
                        <div class="row">
                            <div class="col s10">
                                <p>{{ object.comment_text }}</p>
                                <p class="right-align">{{ object.comment_author }}</p>
                            </div>
                            <div class="col s1">
                                <button class="btn thumb-up" topic_id="{{ topic._id }}" loop_index="{{ loop.index }}"><i class="fas fa-thumbs-up"></i></button>
                                <p>{{ object.comment_pos }}</p>
                            </div>
                            <div class="col s1">
                                <button class="btn thumb-down" topic_id="{{ topic._id }}" loop_index="{{ loop.index }}"><i class="fas fa-thumbs-down"></i></button>
                                <p>{{ object.comment_neg }}</p>
                            </div>
                        </div>
                        <hr>
                        {% endfor %}
                        <!-- Input form for comments/answers -->
                        <form action="{{ url_for('insert_comment', topic_id=topic._id) }}" method="POST">
                            <div class="comment-form">
                                <div class="row">
                                    <div class="input-field col s12">
                                        Write your comment here
                                        <input type="text" class="validate" name="comment_text">
                                    </div>
                                    <div class="input-field col s12">
                                        Your name (will be displayed below the comment)
                                        <input type="text" class="validate" name="comment_author">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <button class="btn cancel-comment" type="button">Cancel              
                                </button>
                                <button class="btn submit-comment" name="action">Submit             
                                </button>
                                <button class="btn add-comment" type="button">New comment              
                                </button>
                            </div>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
      $('select').formSelect();    
      
    // Add commenting functionality
      $(".add-comment").click(function(){
          $(".comment-form").animate({height: "200px"});
          $(".cancel-comment, .submit-comment, .comment-form").show();
          $(".add-comment").hide();
      });
      $(".cancel-comment").click(function(){
          $(".comment-form").animate({height: "0px"}, function(){$(".comment-form").hide()});
          $(".cancel-comment, .submit-comment").hide();
          $(".add-comment").show();
      });
    
      // Add rating functionality (thumbs up/down)
      $(".thumb-up").on('click', function(){
          urlTemplate = "{{ url_for('rate_pos', topic_id='v1', index='v2') }}";
          urlTemplateId = urlTemplate.replace(/v1/, $(this).attr('topic_id'));
          baseUrl = urlTemplateId.replace(/v2/, $(this).attr('loop_index')); 
          thumbsCountDisplay = $(this).next();
          req = $.ajax(baseUrl)
          req.done(function(data){
              let result = JSON.parse(req.responseText)
              $(thumbsCountDisplay).replaceWith(`<p>${result["totalThumbs"]}</p>`);
          });
    
      });
      $(".thumb-down").on('click', function(){
          urlTemplate = "{{ url_for('rate_neg', topic_id='v1', index='v2') }}";
          urlTemplateId = urlTemplate.replace(/v1/, $(this).attr('topic_id'));
          baseUrl = urlTemplateId.replace(/v2/, $(this).attr('loop_index')); 
          thumbsCountDisplay = $(this).next();
          req = $.ajax(baseUrl)
          req.done(function(data){
              let result = JSON.parse(req.responseText)
              $(thumbsCountDisplay).replaceWith(`<p>${result["totalThumbs"]}</p>`);
          })
      });


      $('#searchfield').on("input", function(){
          searchFunction();
      });

      $('#searchInTitles', '#searchInDetails', '#searchInComments').click(function() {
          searchFunction();
      });


      $('#sortdate').change(function() {
          urlTemplate = "{{ url_for('sort_topics_date', date_order='v1') }}";
          baseUrl = urlTemplate.replace(/v1/, $(this).find('option:selected').attr('value'));
          req = $.ajax(baseUrl)
          req.done(function(data){
              $('#topics-table').html(data);
          });
    
      });


      $('#platformfilter').change(function() {
          let items = [];
          $(this).find('option:selected').each(function() {
            item = ($(this).val());
            items.push(item);
          });
          urlTemplate = "{{ url_for('filter_topics_platform', platform_filter='v1') }}";
          baseUrl = urlTemplate.replace(/v1/, items);
          req = $.ajax(baseUrl)
          req.done(function(data){
              $('#topics-table').html(data);
          });
      });
    
      $('#costfilter').change(function() {
          urlTemplate = "{{ url_for('filter_topics_cost', cost_filter='v1') }}";
          baseUrl = urlTemplate.replace(/v1/, $(this).find('option:selected').attr('value'));
          req = $.ajax(baseUrl)
          req.done(function(data){
              $('#topics-table').html(data);
          });
    
      });
    
      $('#answersfilter').change(function() {
          urlTemplate = "{{ url_for('filter_topics_answer', answer_filter='v1') }}";
          baseUrl = urlTemplate.replace(/v1/, $(this).find('option:selected').attr('value'));
          req = $.ajax(baseUrl)
          req.done(function(data){
              $('#topics-table').html(data);
          });
      });
    
    
    
    })

function searchFunction() {
    keyword = $('#searchfield').val();
    if (keyword.length < 1) {
        keyword = ".*";
    }
    
    urlTemplate0 = "{{ url_for('search_topics', search_titles='v1', search_details='v2', search_comments='v3') }}";
    urlTemplate1 = urlTemplate0.replace(/v1/, getCategoryKeyword("#searchInTitles", keyword));
    urlTemplate2 = urlTemplate1.replace(/v2/, getCategoryKeyword("#searchInDetails", keyword));
    baseUrl = urlTemplate2.replace(/v3/, getCategoryKeyword("#searchInComments", keyword));

    req = $.ajax(baseUrl)
    req.done(function(data){
        $('#topics-table').html(data);
    });
}

function getCategoryKeyword(category, keyword){
    if ($(category).is(':checked')) {
        return keyword;
    } else {
        return ".*"
    }
}
    
</script>
{% endblock %}